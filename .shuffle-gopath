#!/bin/sh

: "${CANONICAL_CHARACTER_REPO:=github.com/philpennock/character}"
shuffle_env_cmd="$(dirname "$0")/.shuffle-env-run"

warn() {
	printf >&2 "%s: %s\n" "$(basename $0)" "$*"
}

ensure_have_govendor() {
	# govendor has no -version/-help/whatever that exits true :-(
	(
		set +x
		IFS=:
		set $PATH
		for d; do
			if test -x "$d/govendor"; then exit 0; fi
		done
		exit 1
	) && warn "have govendor" || (
		warn "installing govendor"
		go get -v github.com/kardianos/govendor
	)
}

if test -n "${GOPATH}"; then
	warn "GOPATH is set, can't use this target"
	exit 1
fi

if $shuffle_env_cmd true; then
	warn "shuffling appears unnecessary"
else
	relative_parent="$(dirname "go/src/${CANONICAL_CHARACTER_REPO}")"

	cd ..
	set -e
	mkdir -p "${relative_parent:?}"
	mv -v "$(basename "${CANONICAL_CHARACTER_REPO}")" "${relative_parent}/./"
	cd "go/src/${CANONICAL_CHARACTER_REPO}"
	set +e
fi

eval "$($shuffle_env_cmd show)"

ensure_have_govendor

"$@"
